import pandas as pd
import json
from transformers import pipeline

# === Step 1: Load CSV ===
file_path = "results.csv"  # change to your file name
df = pd.read_csv(file_path)

# === Step 2: Load Phi-2 as text-generation pipeline ===
generator = pipeline(
    "text-generation",
    model="microsoft/phi-2",
    torch_dtype="auto",
    device_map="auto",
    max_new_tokens=300,  # limit output length
    do_sample=False
)

# === Step 3: Function to extract structured JSON ===
def extract_info(text):
    prompt = (
        "Extract the following structured information from the medical text:\n"
        "Visit Reason, Diagnosis, Past Medical History, Clinical Details, Vital Signs, "
        "Exam Results, Lab Results, Imaging Test Results, Hospital and ED course, "
        "Discharge Plan, Full HPI, Full Assessment and Plan.\n"
        "Return output strictly as JSON with keys exactly as mentioned, "
        "and arrays formatted with each string in a new line.\n\n"
        f"Text: {text}\n"
        "JSON:"
    )
    
    output = generator(prompt, max_new_tokens=300)[0]['generated_text']
    
    # Try to parse JSON and pretty print like your screenshot
    try:
        json_start = output.find("{")
        json_end = output.rfind("}") + 1
        if json_start != -1 and json_end != -1:
            parsed = json.loads(output[json_start:json_end])
            return json.dumps(parsed, indent=4, ensure_ascii=False)
        else:
            return output
    except:
        return output  # if not valid JSON, return raw output

# === Step 4: Apply to the "context" column ===
df["microsoft/phi-2"] = df["context"].apply(extract_info)

# === Step 5: Save to same file ===
df.to_csv(file_path, index=False)

print(f"Processing complete. Output saved in: {file_path}")
