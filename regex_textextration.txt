import pandas as pd
import json
import re

# Categories to extract
CATEGORIES = [
    "Visit Reason",
    "Diagnosis",
    "Past Medical History",
    "Clinical Details",
    "Vital Signs",
    "Exam Results",
    "Lab Results",
    "Imaging Test Results",
    "Hospital and ED course",
    "Discharge Plan",
    "Full HPI",
    "Full Assessment and Plan"
]

# Function to extract medical info from context
def extract_info(text):
    text = str(text).strip()
    extracted = {cat: "" if cat != "Diagnosis" else [] for cat in CATEGORIES}

    # Pattern: Category followed by colon or dash, then capture text until next category or end
    pattern = r"(?P<cat>{cats})[:\-]\s*(?P<val>.*?)(?=\n\s*(?:{cats})[:\-]|\Z)".format(
        cats="|".join([re.escape(cat) for cat in CATEGORIES])
    )

    matches = re.finditer(pattern, text, re.IGNORECASE | re.DOTALL)

    for match in matches:
        cat = match.group("cat").strip()
        val = match.group("val").strip()
        if cat.lower() == "diagnosis":
            extracted["Diagnosis"] = [d.strip() for d in re.split(r",|\n", val) if d.strip()]
        else:
            extracted[cat] = val

    return json.dumps(extracted, ensure_ascii=False)

# Read CSV
df = pd.read_csv("results.csv")

# Ensure required columns exist
if "context" not in df.columns or "model_used" not in df.columns:
    raise ValueError("CSV must contain 'context' and 'model_used' columns")

# Process per model
model_dfs = []
for model_name, group in df.groupby("model_used"):
    model_output = group["context"].apply(extract_info)
    temp_df = pd.DataFrame({model_name: model_output})
    temp_df.index = group.index
    model_dfs.append(temp_df)

# Combine all model outputs
final_df = pd.concat(model_dfs, axis=1)

# Save
final_df.to_csv("formatted_output.csv", index=False)

print("âœ… Done! Saved to formatted_output.csv")
print(final_df.head())
