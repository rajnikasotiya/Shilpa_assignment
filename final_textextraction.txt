import pandas as pd
import json
from transformers import pipeline

# === Step 1: Load CSV ===
file_path = "results.csv"  # change to your file name
df = pd.read_csv(file_path)

# === Step 2: Load summarization pipeline ===
summarizer = pipeline(
    "text2text-generation",
    model="microsoft/phi-2",
    max_length=512,
    truncation=True
)

# === Step 3: Function to extract structured JSON ===
def extract_info(text):
    prompt = (
        "Extract the following structured information from the medical text:\n"
        "Visit Reason, Diagnosis, Past Medical History, Clinical Details, Vital Signs, "
        "Exam Results, Lab Results, Imaging Test Results, Hospital and ED course, "
        "Discharge Plan, Full HPI, Full Assessment and Plan.\n"
        "Return output strictly as JSON with keys exactly as mentioned, "
        "and arrays formatted with each string in a new line.\n\n"
        f"Text: {text}"
    )
    
    output = summarizer(prompt, do_sample=False)[0]['generated_text']
    
    # Try to parse JSON and pretty print like your screenshot
    try:
        parsed = json.loads(output)
        return json.dumps(parsed, indent=4, ensure_ascii=False)  # keeps indentation
    except:
        return output  # if not valid JSON, return raw output

# === Step 4: Apply to the "context" column ===
df["microsoft/phi-2"] = df["context"].apply(extract_info)

# === Step 5: Save to same file ===
df.to_csv(file_path, index=False)

print(f"Processing complete. Output saved in: {file_path}")
