from transformers import pipeline
import pandas as pd
import json

# === Load CSV and get first row of 'context' column ===
df = pd.read_csv("results3.csv")
record_text = str(df.loc[0, "context"])  # take first row as string

# === Load a text-generation model ===
extractor = pipeline("text2text-generation", model="google/flan-t5-base")

# === Prompt for structured extraction ===
prompt = f"""
Extract the following fields from the medical record and return in JSON format:
- Visit Reason
- History
- Diagnosis
- Lab Results
- Treatment Plan

Medical Record:
{record_text}
"""

# === Run model ===
response = extractor(prompt, max_length=512, clean_up_tokenization_spaces=True)[0]['generated_text']

# === Parse JSON output if possible ===
try:
    structured_data = json.loads(response)
except:
    structured_data = {"raw_output": response}  # fallback if not valid JSON

print(structured_data)
